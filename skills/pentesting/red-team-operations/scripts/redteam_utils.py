#!/usr/bin/env python3
"""
Red Team Operations Utility Functions

Utilities for red team operation management.

Usage:
    from redteam_utils import RedTeamOp, AdversaryProfile, C2Manager
"""

import json
import logging
from datetime import datetime
from typing import Dict, List, Any
from dataclasses import dataclass, field

logger = logging.getLogger(__name__)


@dataclass
class Objective:
    """Operation objective."""
    name: str
    description: str
    priority: str
    points: int
    completed: bool = False
    evidence: str = ''
    completed_at: str = ''


@dataclass
class Implant:
    """C2 implant."""
    name: str
    host: str
    user: str
    implant_type: str
    callback_time: int
    first_seen: str = ''
    last_seen: str = ''


class RedTeamOp:
    """Red team operation management."""

    def __init__(self, name: str):
        self.name = name
        self.client = None
        self.scope = {}
        self.objectives: List[Objective] = []
        self.timeline = {}
        self.phases = []
        self.roe = {}
        self.created_at = datetime.now()

    def set_client(self, client: str):
        """Set client name."""
        self.client = client

    def set_scope(self, scope: Dict[str, Any]):
        """Set operation scope."""
        self.scope = scope

    def add_objective(self, name: str, description: str,
                      priority: str, points: int):
        """Add operation objective."""
        self.objectives.append(Objective(
            name=name,
            description=description,
            priority=priority,
            points=points
        ))

    def set_timeline(self, start: str, end: str):
        """Set operation timeline."""
        self.timeline = {'start': start, 'end': end}

    def add_phase(self, name: str, start: str, end: str):
        """Add operation phase."""
        self.phases.append({
            'name': name,
            'start': start,
            'end': end
        })

    def set_roe(self, roe: Dict[str, Any]):
        """Set rules of engagement."""
        self.roe = roe

    def export_plan(self, filepath: str):
        """Export operation plan."""
        plan = {
            'name': self.name,
            'client': self.client,
            'scope': self.scope,
            'objectives': [o.__dict__ for o in self.objectives],
            'timeline': self.timeline,
            'phases': self.phases,
            'roe': self.roe
        }
        with open(filepath, 'w') as f:
            json.dump(plan, f, indent=2)


class AdversaryProfile:
    """Adversary emulation profile."""

    PROFILES = {
        'APT29': {
            'aliases': ['Cozy Bear', 'The Dukes'],
            'origin': 'Russia',
            'motivation': 'Espionage'
        },
        'APT28': {
            'aliases': ['Fancy Bear', 'Sofacy'],
            'origin': 'Russia',
            'motivation': 'Espionage'
        }
    }

    def __init__(self, adversary: str):
        self.adversary = adversary
        self.profile = self.PROFILES.get(adversary, {})

    def get_ttps(self) -> Dict[str, List[str]]:
        """Get adversary TTPs."""
        return {
            'initial_access': [],
            'execution': [],
            'persistence': [],
            'privilege_escalation': [],
            'defense_evasion': [],
            'credential_access': [],
            'discovery': [],
            'lateral_movement': [],
            'collection': [],
            'command_and_control': [],
            'exfiltration': []
        }

    def get_tools(self) -> List[str]:
        """Get adversary tools."""
        return []

    def get_iocs(self) -> Dict[str, List[str]]:
        """Get adversary IOCs."""
        return {
            'ips': [],
            'domains': [],
            'hashes': []
        }

    def generate_attack_plan(self) -> List[Dict[str, Any]]:
        """Generate attack plan based on TTPs."""
        return []

    def get_attack_mapping(self) -> Dict[str, Any]:
        """Get MITRE ATT&CK mapping."""
        return {}


class C2Manager:
    """Command and control management."""

    def __init__(self):
        self.redirectors = []
        self.teamservers = []
        self.implants: List[Implant] = []
        self.command_log = []

    def add_redirector(self, name: str, ip: str, provider: str):
        """Add redirector."""
        self.redirectors.append({
            'name': name,
            'ip': ip,
            'provider': provider
        })

    def add_teamserver(self, name: str, ip: str, framework: str):
        """Add team server."""
        self.teamservers.append({
            'name': name,
            'ip': ip,
            'framework': framework
        })

    def add_implant(self, name: str, host: str, user: str,
                    implant_type: str, callback_time: int):
        """Add implant."""
        self.implants.append(Implant(
            name=name,
            host=host,
            user=user,
            implant_type=implant_type,
            callback_time=callback_time,
            first_seen=datetime.now().isoformat()
        ))

    def log_command(self, implant: str, command: str, output: str):
        """Log command execution."""
        self.command_log.append({
            'implant': implant,
            'command': command,
            'output': output,
            'timestamp': datetime.now().isoformat()
        })

    def list_sessions(self) -> List[Dict[str, Any]]:
        """List active sessions."""
        return [
            {
                'name': i.name,
                'host': i.host,
                'user': i.user
            }
            for i in self.implants
        ]

    def rotate_infrastructure(self, name: str):
        """Rotate infrastructure."""
        logger.info(f"Rotating {name}")

    def export_iocs(self, filepath: str):
        """Export IOCs for deconfliction."""
        iocs = {
            'ips': [r['ip'] for r in self.redirectors],
            'domains': []
        }
        with open(filepath, 'w') as f:
            json.dump(iocs, f, indent=2)


class ObjectiveTracker:
    """Track operation objectives."""

    def __init__(self, operation: str):
        self.operation = operation
        self.objectives = []
        self.flags = []
        self.events = []

    def mark_complete(self, objective: str, evidence: str,
                      timestamp: str, operator: str):
        """Mark objective as complete."""
        self.events.append({
            'action': f'Completed: {objective}',
            'time': timestamp,
            'operator': operator,
            'evidence': evidence
        })

    def add_flag(self, name: str, value: str, location: str, points: int):
        """Add captured flag."""
        self.flags.append({
            'name': name,
            'value': value,
            'location': location,
            'points': points,
            'captured_at': datetime.now().isoformat()
        })

    def get_progress(self) -> Dict[str, int]:
        """Get operation progress."""
        completed = len([o for o in self.objectives if o.get('completed')])
        points = sum(f['points'] for f in self.flags)
        return {
            'completed': completed,
            'total': len(self.objectives),
            'points': points,
            'max_points': 0
        }

    def get_timeline(self) -> List[Dict[str, Any]]:
        """Get event timeline."""
        return sorted(self.events, key=lambda x: x['time'])


class OPSEC:
    """Operational security management."""

    def __init__(self):
        self.events = []

    def get_checklist(self) -> List[str]:
        """Get OPSEC checklist."""
        return [
            'Use encrypted communications',
            'Rotate infrastructure regularly',
            'Avoid working hours detection',
            'Use legitimate-looking domains',
            'Clear logs on exit',
            'Use traffic blending',
            'Verify before execution'
        ]

    def log_event(self, event: str, risk: str, mitigation: str):
        """Log OPSEC event."""
        self.events.append({
            'event': event,
            'risk': risk,
            'mitigation': mitigation,
            'timestamp': datetime.now().isoformat()
        })

    def check_infrastructure(self, ips: List[str]) -> Dict[str, Any]:
        """Check infrastructure OPSEC."""
        return {'clean': True, 'issues': []}

    def sanitize_data(self, data: Any) -> Any:
        """Sanitize data for exfiltration."""
        return data

    def generate_report(self) -> str:
        """Generate OPSEC report."""
        return "# OPSEC Report\n"
