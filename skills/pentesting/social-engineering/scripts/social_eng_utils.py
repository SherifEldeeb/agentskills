#!/usr/bin/env python3
"""
Social Engineering Utility Functions

Utilities for authorized social engineering assessments.

Usage:
    from social_eng_utils import PhishingCampaign, Pretext, CampaignMetrics
"""

import json
import logging
from datetime import datetime
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, field

logger = logging.getLogger(__name__)


@dataclass
class Target:
    """Phishing target."""
    email: str
    first_name: str = ''
    last_name: str = ''
    department: str = ''
    sent: bool = False
    opened: bool = False
    clicked: bool = False
    submitted: bool = False


class PhishingCampaign:
    """Manage phishing campaigns."""

    def __init__(self, name: str):
        self.name = name
        self.sender_email = None
        self.sender_name = None
        self.landing_page = None
        self.templates = []
        self.targets: List[Target] = []
        self.schedule_start = None
        self.spread_hours = 1
        self.status = 'draft'

    def set_sender(self, email: str, name: str):
        """Set sender information."""
        self.sender_email = email
        self.sender_name = name

    def set_landing_page(self, url: str):
        """Set landing page URL."""
        self.landing_page = url

    def add_template(self, name: str = None, subject: str = None,
                     body: str = None):
        """Add email template."""
        self.templates.append({
            'name': name,
            'subject': subject,
            'body': body
        })

    def add_targets(self, emails: List[str]):
        """Add target emails."""
        for email in emails:
            self.targets.append(Target(email=email))

    def import_targets(self, filepath: str):
        """Import targets from CSV."""
        logger.info(f"Importing targets from {filepath}")

    def set_schedule(self, start: str, spread_hours: int = 1):
        """Set campaign schedule."""
        self.schedule_start = start
        self.spread_hours = spread_hours

    def launch(self):
        """Launch the campaign."""
        logger.warning(f"Launching campaign: {self.name}")
        self.status = 'running'

    def get_status(self) -> Dict[str, int]:
        """Get campaign status."""
        return {
            'total': len(self.targets),
            'sent': sum(1 for t in self.targets if t.sent),
            'opened': sum(1 for t in self.targets if t.opened),
            'clicked': sum(1 for t in self.targets if t.clicked),
            'submitted': sum(1 for t in self.targets if t.submitted)
        }

    def get_results(self) -> List[Dict[str, Any]]:
        """Get detailed results."""
        return [
            {
                'email': t.email,
                'sent': t.sent,
                'opened': t.opened,
                'clicked': t.clicked,
                'submitted': t.submitted
            }
            for t in self.targets
        ]


class EmailTemplate:
    """Email template creation."""

    def __init__(self):
        self.subject = ''
        self.body = ''
        self.personalization_fields = []

    def create_password_reset(self, company: str, urgency: str = 'medium'):
        """Create password reset template."""
        self.subject = f"[Urgent] {company} Password Reset Required"
        self.body = f"""Dear {{first_name}},

Your {company} password is about to expire. Please reset it immediately.

Click here to reset: {{tracking_link}}

{company} IT Security"""

    def create_document_share(self, platform: str, sender_name: str):
        """Create document share template."""
        self.subject = f"{sender_name} shared a document with you"
        self.body = f"""{{first_name}},

{sender_name} shared a document with you on {platform}.

View document: {{tracking_link}}

{platform} Team"""

    def create_invoice_notification(self, vendor: str, amount: str):
        """Create invoice template."""
        self.subject = f"Invoice #{vendor} - {amount}"
        self.body = f"""Dear {{first_name}},

Please review your {vendor} invoice for {amount}.

View invoice: {{tracking_link}}

{vendor} Billing"""

    def create_mfa_approval(self, service: str):
        """Create MFA approval template."""
        self.subject = f"New sign-in to your {service} account"
        self.body = f"""Hello {{first_name}},

We noticed a new sign-in to your account. If this was you, approve it here:

{{tracking_link}}

{service} Security"""

    def set_personalization(self, fields: List[str]):
        """Set personalization fields."""
        self.personalization_fields = fields

    def add_tracking_pixel(self):
        """Add tracking pixel."""
        self.body += '\n<img src="{tracking_pixel}" width="1" height="1">'

    def add_click_tracking(self):
        """Add click tracking."""
        pass

    def render(self, data: Dict[str, str]) -> str:
        """Render template with data."""
        result = self.body
        for key, value in data.items():
            result = result.replace(f"{{{key}}}", value)
        return result

    def export(self, filepath: str):
        """Export template."""
        with open(filepath, 'w') as f:
            f.write(self.body)


class Pretext:
    """Pretext development."""

    templates = {
        'it_support': {
            'role': 'IT Support Technician',
            'scenario': 'Helping with technical issue',
            'objectives': ['credentials', 'system access']
        },
        'vendor': {
            'role': 'Vendor Representative',
            'scenario': 'Following up on service',
            'objectives': ['contact info', 'system info']
        },
        'new_employee': {
            'role': 'New Employee',
            'scenario': 'First week, needs help',
            'objectives': ['badge access', 'credentials']
        },
        'executive_assistant': {
            'role': 'Executive Assistant',
            'scenario': 'Urgent request from executive',
            'objectives': ['wire transfer', 'credentials']
        }
    }

    def create(self, role: str, objective: str,
               target_department: str) -> Dict[str, Any]:
        """Create pretext scenario."""
        return {
            'role': role,
            'objective': objective,
            'target_department': target_department,
            'created_at': datetime.now().isoformat()
        }

    def generate_script(self, scenario: Dict, style: str = 'normal') -> str:
        """Generate call script."""
        script = f"""# Pretext Script

## Role: {scenario['role']}
## Objective: {scenario['objective']}
## Target: {scenario['target_department']}

### Opening
"Hi, this is [NAME] from [DEPARTMENT]. I'm calling about..."

### Information Gathering
1. Verify target identity
2. Build rapport
3. Introduce problem

### Main Request
"I need your help with..."

### Closing
"Thank you so much for your help!"
"""
        return script

    def get_objection_handlers(self, scenario: Dict) -> Dict[str, str]:
        """Get objection handling responses."""
        return {
            "I need to verify your identity": "Of course! You can call the main line and ask for me.",
            "I'm not authorized": "No problem, who should I speak with?",
            "This seems suspicious": "I completely understand your caution..."
        }


class LandingPage:
    """Credential harvesting landing pages."""

    def __init__(self):
        self.content = ''
        self.fields = []
        self.redirect_url = None

    def clone(self, url: str):
        """Clone existing page."""
        logger.info(f"Cloning {url}")

    def set_logo(self, logo_path: str):
        """Set custom logo."""
        pass

    def add_credential_capture(self, fields: List[str]):
        """Add credential capture fields."""
        self.fields = fields

    def add_redirect(self, url: str):
        """Set redirect URL."""
        self.redirect_url = url

    def use_template(self, template_name: str):
        """Use predefined template."""
        logger.info(f"Using template: {template_name}")

    def export(self, directory: str):
        """Export landing page."""
        logger.info(f"Exporting to {directory}")

    def get_submissions(self) -> List[Dict[str, Any]]:
        """Get credential submissions."""
        return []


class PhysicalTest:
    """Physical security testing."""

    def __init__(self, name: str):
        self.name = name
        self.techniques = []
        self.attempts = []

    def add_technique(self, name: str, description: str,
                      success_indicators: List[str] = None,
                      props: List[str] = None):
        """Add testing technique."""
        self.techniques.append({
            'name': name,
            'description': description,
            'success_indicators': success_indicators or [],
            'props': props or []
        })

    def log_attempt(self, technique: str, location: str,
                    time: str, result: str, notes: str = ''):
        """Log attempt."""
        self.attempts.append({
            'technique': technique,
            'location': location,
            'time': time,
            'result': result,
            'notes': notes
        })

    def generate_report(self) -> str:
        """Generate assessment report."""
        report = f"# Physical Security Assessment: {self.name}\n\n"
        report += f"## Attempts: {len(self.attempts)}\n\n"
        for attempt in self.attempts:
            report += f"### {attempt['technique']} at {attempt['location']}\n"
            report += f"Result: {attempt['result']}\n\n"
        return report


class USBDropCampaign:
    """USB drop campaign."""

    def __init__(self, name: str):
        self.name = name
        self.payload_type = 'beacon'
        self.callback_url = None
        self.files = []
        self.drops = []
        self.connections = []

    def set_payload_type(self, payload_type: str):
        """Set payload type."""
        self.payload_type = payload_type

    def set_callback_url(self, url: str):
        """Set callback URL."""
        self.callback_url = url

    def create_enticing_files(self, filenames: List[str]):
        """Create enticing files."""
        self.files = filenames

    def log_drop(self, location: str, label: str, time: str):
        """Log USB drop."""
        self.drops.append({
            'location': location,
            'label': label,
            'time': time
        })

    def get_connections(self) -> List[Dict[str, Any]]:
        """Get USB connections."""
        return self.connections


class CampaignMetrics:
    """Campaign metrics and reporting."""

    def __init__(self, campaign: PhishingCampaign = None):
        self.campaign = campaign
        self.data = {}

    def load_campaign(self, campaign_id: str):
        """Load campaign data."""
        logger.info(f"Loading campaign {campaign_id}")

    def get_summary(self) -> Dict[str, Any]:
        """Get campaign summary."""
        if not self.campaign:
            return {}
        status = self.campaign.get_status()
        total = status['total'] or 1
        return {
            'total': status['total'],
            'opened': status['opened'],
            'open_rate': round(status['opened'] / total * 100, 1),
            'clicked': status['clicked'],
            'click_rate': round(status['clicked'] / total * 100, 1),
            'submitted': status['submitted'],
            'submit_rate': round(status['submitted'] / total * 100, 1)
        }

    def breakdown_by(self, field: str) -> Dict[str, Dict]:
        """Break down results by field."""
        return {}

    def get_timeline(self) -> List[Dict[str, Any]]:
        """Get timeline of events."""
        return []

    def find_repeat_offenders(self) -> List[str]:
        """Find repeat offenders."""
        return []

    def generate_executive_report(self) -> str:
        """Generate executive report."""
        summary = self.get_summary()
        return f"""# Phishing Campaign Executive Report

## Summary
- Total targets: {summary.get('total', 0)}
- Open rate: {summary.get('open_rate', 0)}%
- Click rate: {summary.get('click_rate', 0)}%
- Credential submission rate: {summary.get('submit_rate', 0)}%

## Recommendations
1. Conduct additional security awareness training
2. Implement email filtering improvements
3. Enable MFA for all users
"""
