#!/usr/bin/env python3
"""
Password Attack Utility Functions

Utilities for password security assessment during penetration testing.

Usage:
    from password_utils import HashCracker, PasswordSprayer, WordlistGenerator
"""

import re
import json
import hashlib
import logging
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, field

logger = logging.getLogger(__name__)


@dataclass
class CrackedPassword:
    """Represents a cracked password."""
    hash_value: str
    hash_type: str
    password: str
    method: str


class HashCracker:
    """Hash cracking operations."""

    HASH_MODES = {
        'md5': {'hashcat': 0, 'john': 'raw-md5'},
        'sha1': {'hashcat': 100, 'john': 'raw-sha1'},
        'sha256': {'hashcat': 1400, 'john': 'raw-sha256'},
        'sha512': {'hashcat': 1700, 'john': 'raw-sha512'},
        'ntlm': {'hashcat': 1000, 'john': 'nt'},
        'lm': {'hashcat': 3000, 'john': 'lm'},
        'bcrypt': {'hashcat': 3200, 'john': 'bcrypt'},
        'md5crypt': {'hashcat': 500, 'john': 'md5crypt'},
        'sha512crypt': {'hashcat': 1800, 'john': 'sha512crypt'},
        'mssql': {'hashcat': 1731, 'john': 'mssql12'},
        'mysql': {'hashcat': 300, 'john': 'mysql-sha1'},
        'postgres': {'hashcat': 12, 'john': 'postgres'}
    }

    def __init__(self):
        self.hashes = []
        self.cracked: List[CrackedPassword] = []

    def add_hash(self, hash_value: str, hash_type: str):
        """Add hash to crack."""
        self.hashes.append({
            'hash': hash_value,
            'type': hash_type
        })

    def import_hashes(self, filepath: str, hash_type: str = None,
                      auto_detect: bool = False):
        """Import hashes from file."""
        logger.info(f"Importing hashes from {filepath}")

    def crack_dictionary(self, wordlist: str) -> List[Dict[str, str]]:
        """Dictionary attack."""
        logger.info(f"Dictionary attack with {wordlist}")
        return []

    def crack_with_rules(self, wordlist: str, rules: str) -> List[Dict[str, str]]:
        """Dictionary attack with rules."""
        logger.info(f"Dictionary + rules attack")
        return []

    def crack_brute_force(self, charset: str, min_length: int,
                          max_length: int) -> List[Dict[str, str]]:
        """Brute force attack."""
        logger.info(f"Brute force attack: {charset} ({min_length}-{max_length})")
        return []

    def crack_mask(self, mask: str) -> List[Dict[str, str]]:
        """Mask attack."""
        logger.info(f"Mask attack: {mask}")
        return []

    def crack_combinator(self, wordlist1: str, wordlist2: str) -> List[Dict[str, str]]:
        """Combinator attack."""
        logger.info(f"Combinator attack")
        return []

    def get_stats(self) -> Dict[str, int]:
        """Get cracking statistics."""
        return {
            'total': len(self.hashes),
            'cracked': len(self.cracked),
            'remaining': len(self.hashes) - len(self.cracked)
        }

    def export_results(self, filepath: str):
        """Export cracked passwords."""
        with open(filepath, 'w') as f:
            for c in self.cracked:
                f.write(f"{c.hash_value}:{c.password}\n")


class HashIdentifier:
    """Identify hash types."""

    PATTERNS = {
        'md5': (r'^[a-fA-F0-9]{32}$', 0),
        'sha1': (r'^[a-fA-F0-9]{40}$', 100),
        'sha256': (r'^[a-fA-F0-9]{64}$', 1400),
        'sha512': (r'^[a-fA-F0-9]{128}$', 1700),
        'ntlm': (r'^[a-fA-F0-9]{32}$', 1000),
        'lm': (r'^[a-fA-F0-9]{32}$', 3000),
        'bcrypt': (r'^\$2[ayb]\$.{56}$', 3200),
        'md5crypt': (r'^\$1\$.{8}\$.{22}$', 500),
        'sha512crypt': (r'^\$6\$.{8,16}\$.{86}$', 1800)
    }

    def identify(self, hash_value: str) -> Dict[str, Any]:
        """Identify hash type."""
        possible = []
        for hash_type, (pattern, mode) in self.PATTERNS.items():
            if re.match(pattern, hash_value):
                possible.append({
                    'type': hash_type,
                    'hashcat': mode,
                    'john': hash_type
                })

        if possible:
            return possible[0]
        return {'type': 'unknown', 'hashcat': None, 'john': None}

    def get_examples(self, hash_type: str) -> Dict[str, str]:
        """Get example hashes."""
        examples = {
            'md5': '5f4dcc3b5aa765d61d8327deb882cf99',
            'sha1': '5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8',
            'ntlm': 'cc348bace876ea440a28ddaeb9fd3550',
            'bcrypt': '$2a$10$N9qo8uLOickgx2ZMRZoMye...'
        }
        return {'example': examples.get(hash_type, 'N/A')}


class PasswordSprayer:
    """Password spraying attacks."""

    def __init__(self, domain: str = None):
        self.domain = domain
        self.users = []
        self.target_type = None
        self.target_host = None
        self.target_port = None
        self.delay_minutes = 30
        self.lockout_threshold = 5
        self.results = []

    def add_users(self, users: List[str]):
        """Add users to spray."""
        self.users.extend(users)

    def import_users(self, filepath: str):
        """Import users from file."""
        logger.info(f"Importing users from {filepath}")

    def set_target(self, target_type: str, host: str, port: int = None):
        """Set spray target."""
        self.target_type = target_type
        self.target_host = host
        self.target_port = port

    def set_delay(self, minutes: int):
        """Set delay between sprays."""
        self.delay_minutes = minutes

    def set_lockout_threshold(self, threshold: int):
        """Set lockout threshold."""
        self.lockout_threshold = threshold

    def spray(self, passwords: List[str],
              delay_minutes: int = None) -> List[Dict[str, str]]:
        """Perform password spray."""
        delay = delay_minutes or self.delay_minutes
        logger.info(f"Spraying {len(passwords)} passwords against {len(self.users)} users")
        return self.results

    def export_results(self, filepath: str):
        """Export spray results."""
        with open(filepath, 'w') as f:
            json.dump(self.results, f, indent=2)


class BruteForcer:
    """Online brute force attacks."""

    def __init__(self):
        self.results = []

    def attack_ssh(self, target: str, username: str,
                   wordlist: str, threads: int = 4) -> Dict[str, Any]:
        """SSH brute force."""
        logger.info(f"SSH brute force against {target}")
        return {'success': False, 'password': None}

    def attack_http_basic(self, url: str, username: str,
                          wordlist: str) -> Dict[str, Any]:
        """HTTP Basic Auth brute force."""
        logger.info(f"HTTP Basic brute force against {url}")
        return {'success': False, 'password': None}

    def attack_http_form(self, url: str, username: str, wordlist: str,
                         username_field: str, password_field: str,
                         success_indicator: str, failure_indicator: str) -> Dict[str, Any]:
        """HTTP form brute force."""
        logger.info(f"HTTP form brute force against {url}")
        return {'success': False, 'password': None}

    def attack_ftp(self, target: str, username: str,
                   wordlist: str) -> Dict[str, Any]:
        """FTP brute force."""
        logger.info(f"FTP brute force against {target}")
        return {'success': False, 'password': None}

    def attack_smb(self, target: str, username: str,
                   wordlist: str) -> Dict[str, Any]:
        """SMB brute force."""
        logger.info(f"SMB brute force against {target}")
        return {'success': False, 'password': None}


class WordlistGenerator:
    """Generate targeted wordlists."""

    LEET_MAP = {
        'a': ['4', '@'],
        'e': ['3'],
        'i': ['1', '!'],
        'o': ['0'],
        's': ['5', '$'],
        't': ['7']
    }

    SPECIAL_CHARS = ['!', '@', '#', '$', '%', '&', '*']
    COMMON_NUMBERS = ['1', '12', '123', '1234', '!', '01', '001']

    def __init__(self, target_name: str = ''):
        self.target_name = target_name
        self.base_words = []
        self.numbers = []
        self.years = []
        self.mutations = []
        self.wordlist = []

    def add_words(self, words: List[str]):
        """Add base words."""
        self.base_words.extend(words)

    def add_numbers(self, numbers):
        """Add numbers."""
        self.numbers.extend([str(n) for n in numbers])

    def add_years(self, years):
        """Add years."""
        self.years.extend([str(y) for y in years])

    def add_common_patterns(self):
        """Add common password patterns."""
        self.base_words.extend([
            'password', 'welcome', 'admin', 'login',
            'spring', 'summer', 'fall', 'winter',
            'january', 'february', 'march', 'april', 'may', 'june',
            'july', 'august', 'september', 'october', 'november', 'december'
        ])

    def apply_mutations(self, mutations: List[str]):
        """Apply mutations."""
        self.mutations = mutations

    def generate(self) -> List[str]:
        """Generate wordlist."""
        self.wordlist = []

        for word in self.base_words:
            self.wordlist.append(word)
            self.wordlist.append(word.capitalize())
            self.wordlist.append(word.upper())

            for num in self.numbers:
                self.wordlist.append(f"{word}{num}")
                self.wordlist.append(f"{word.capitalize()}{num}")

            for year in self.years:
                self.wordlist.append(f"{word}{year}")
                self.wordlist.append(f"{word.capitalize()}{year}")

            for char in self.SPECIAL_CHARS:
                self.wordlist.append(f"{word}{char}")
                self.wordlist.append(f"{word.capitalize()}{char}")

        return list(set(self.wordlist))

    def add_from_linkedin(self, company: str):
        """Add words from LinkedIn OSINT."""
        logger.info(f"Gathering from LinkedIn: {company}")

    def add_from_website(self, url: str):
        """Add words from website."""
        logger.info(f"Gathering from website: {url}")

    def generate_targeted(self) -> List[str]:
        """Generate targeted wordlist."""
        if self.target_name:
            self.add_words([self.target_name.lower()])
        return self.generate()

    def export(self, filepath: str):
        """Export wordlist."""
        with open(filepath, 'w') as f:
            for word in self.wordlist:
                f.write(f"{word}\n")

    def generate_rules(self) -> List[str]:
        """Generate mutation rules."""
        return []

    def export_rules(self, filepath: str):
        """Export rules file."""
        pass


class PasswordAnalyzer:
    """Analyze password patterns."""

    def __init__(self):
        self.passwords = []

    def load_passwords(self, filepath: str):
        """Load passwords from file."""
        logger.info(f"Loading passwords from {filepath}")

    def analyze(self) -> Dict[str, Any]:
        """Analyze loaded passwords."""
        return {
            'total': len(self.passwords),
            'avg_length': 0,
            'min_length': 0,
            'max_length': 0,
            'with_numbers': 0,
            'with_special': 0,
            'with_upper': 0,
            'with_lower': 0
        }

    def find_patterns(self) -> Dict[str, List]:
        """Find common patterns."""
        return {
            'top': [],
            'bases': [],
            'suffixes': [],
            'prefixes': []
        }

    def check_policy(self, policy: Dict[str, Any]) -> Dict[str, Any]:
        """Check passwords against policy."""
        return {'violations': 0}

    def generate_report(self) -> str:
        """Generate analysis report."""
        return "# Password Analysis Report\n"


class RuleGenerator:
    """Generate password mutation rules."""

    def __init__(self):
        self.rules = []

    def learn_from_pairs(self, pairs: List[tuple]):
        """Learn rules from password pairs."""
        for original, mutated in pairs:
            logger.debug(f"Learning: {original} -> {mutated}")

    def add_case_rules(self):
        """Add case mutation rules."""
        self.rules.extend([':', 'u', 'c', 'C', 't'])

    def add_leet_rules(self):
        """Add leetspeak rules."""
        self.rules.extend(['sa@', 'se3', 'si1', 'so0', 'ss$'])

    def add_append_rules(self, suffixes: List[str]):
        """Add append rules."""
        for s in suffixes:
            self.rules.append(f"${s}")

    def add_prepend_rules(self, prefixes: List[str]):
        """Add prepend rules."""
        for p in prefixes:
            self.rules.append(f"^{p}")

    def combine_rules(self, max_depth: int = 2):
        """Combine rules."""
        pass

    def export_hashcat(self, filepath: str):
        """Export hashcat rules."""
        with open(filepath, 'w') as f:
            for rule in self.rules:
                f.write(f"{rule}\n")

    def export_john(self, filepath: str):
        """Export john rules."""
        pass

    def test_coverage(self, wordlist: str, hashes: str) -> float:
        """Test rule coverage."""
        return 0.0
