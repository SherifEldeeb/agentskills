#!/usr/bin/env python3
"""
Cloud Security Testing Utility Functions

Utilities for cloud security assessment.

Usage:
    from cloud_utils import AWSAssessor, AzureAssessor, GCPAssessor
"""

import json
import logging
from typing import Dict, List, Any
from dataclasses import dataclass

logger = logging.getLogger(__name__)


@dataclass
class CloudFinding:
    """Cloud security finding."""
    severity: str
    resource: str
    issue: str
    recommendation: str
    cloud: str


class AWSAssessor:
    """AWS security assessment."""

    def __init__(self, access_key: str = None, secret_key: str = None,
                 region: str = 'us-east-1'):
        self.access_key = access_key
        self.secret_key = secret_key
        self.region = region
        self.findings: List[CloudFinding] = []

    def analyze_iam(self) -> Dict[str, Any]:
        """Analyze IAM configuration."""
        logger.info("Analyzing AWS IAM")
        return {
            'users': [],
            'roles': [],
            'policies': [],
            'admin_users': [],
            'overprivileged': []
        }

    def analyze_s3(self) -> Dict[str, Any]:
        """Analyze S3 bucket security."""
        logger.info("Analyzing S3 buckets")
        return {
            'buckets': [],
            'public_buckets': [],
            'unencrypted': [],
            'no_logging': []
        }

    def analyze_ec2(self) -> Dict[str, Any]:
        """Analyze EC2 security."""
        logger.info("Analyzing EC2 instances")
        return {
            'instances': [],
            'public_instances': [],
            'imdsv1_enabled': []
        }

    def analyze_security_groups(self) -> Dict[str, Any]:
        """Analyze security groups."""
        return {
            'security_groups': [],
            'overly_permissive': []
        }

    def find_exposed_secrets(self) -> List[Dict[str, Any]]:
        """Find exposed secrets."""
        return []

    def find_privesc_paths(self) -> List[Dict[str, Any]]:
        """Find privilege escalation paths."""
        return []

    def run_assessment(self) -> Dict[str, Any]:
        """Run full AWS assessment."""
        logger.info("Running full AWS assessment")
        return {
            'iam': self.analyze_iam(),
            's3': self.analyze_s3(),
            'ec2': self.analyze_ec2(),
            'findings': self.findings
        }

    def export_report(self, filepath: str):
        """Export assessment report."""
        with open(filepath, 'w') as f:
            json.dump({'findings': [f.__dict__ for f in self.findings]}, f, indent=2)


class AzureAssessor:
    """Azure security assessment."""

    def __init__(self, tenant_id: str = None, client_id: str = None,
                 client_secret: str = None):
        self.tenant_id = tenant_id
        self.client_id = client_id
        self.client_secret = client_secret
        self.findings: List[CloudFinding] = []

    def analyze_entra_id(self) -> Dict[str, Any]:
        """Analyze Entra ID (Azure AD)."""
        logger.info("Analyzing Entra ID")
        return {
            'users': [],
            'groups': [],
            'global_admins': [],
            'guests': [],
            'mfa_disabled': []
        }

    def analyze_storage(self) -> Dict[str, Any]:
        """Analyze storage accounts."""
        return {
            'accounts': [],
            'public_containers': [],
            'unencrypted': []
        }

    def analyze_vms(self) -> Dict[str, Any]:
        """Analyze virtual machines."""
        return {
            'vms': [],
            'public_ips': [],
            'unpatched': []
        }

    def analyze_key_vault(self) -> Dict[str, Any]:
        """Analyze Key Vault."""
        return {
            'vaults': [],
            'exposed_secrets': []
        }

    def analyze_nsgs(self) -> Dict[str, Any]:
        """Analyze Network Security Groups."""
        return {
            'nsgs': [],
            'overly_permissive': []
        }

    def find_privesc_paths(self) -> List[Dict[str, Any]]:
        """Find privilege escalation paths."""
        return []

    def run_assessment(self) -> Dict[str, Any]:
        """Run full Azure assessment."""
        logger.info("Running full Azure assessment")
        return {
            'entra_id': self.analyze_entra_id(),
            'storage': self.analyze_storage(),
            'findings': self.findings
        }


class GCPAssessor:
    """GCP security assessment."""

    def __init__(self, credentials_file: str = None, project: str = None):
        self.credentials_file = credentials_file
        self.project = project
        self.findings: List[CloudFinding] = []

    def analyze_iam(self) -> Dict[str, Any]:
        """Analyze IAM configuration."""
        logger.info("Analyzing GCP IAM")
        return {
            'members': [],
            'primitive_roles': [],
            'owners': []
        }

    def analyze_gcs(self) -> Dict[str, Any]:
        """Analyze GCS bucket security."""
        return {
            'buckets': [],
            'public_buckets': [],
            'uniform_access': []
        }

    def analyze_compute(self) -> Dict[str, Any]:
        """Analyze Compute Engine."""
        return {
            'instances': [],
            'public_instances': []
        }

    def analyze_firewall(self) -> Dict[str, Any]:
        """Analyze firewall rules."""
        return {
            'rules': [],
            'overly_permissive': []
        }

    def analyze_service_accounts(self) -> Dict[str, Any]:
        """Analyze service accounts."""
        return {
            'accounts': [],
            'exposed_keys': []
        }

    def run_assessment(self) -> Dict[str, Any]:
        """Run full GCP assessment."""
        logger.info("Running full GCP assessment")
        return {
            'iam': self.analyze_iam(),
            'gcs': self.analyze_gcs(),
            'findings': self.findings
        }


class MultiCloudAssessor:
    """Multi-cloud security assessment."""

    def __init__(self):
        self.aws = None
        self.azure = None
        self.gcp = None
        self.findings = []

    def add_aws(self, assessor: AWSAssessor):
        """Add AWS assessor."""
        self.aws = assessor

    def add_azure(self, assessor: AzureAssessor):
        """Add Azure assessor."""
        self.azure = assessor

    def add_gcp(self, assessor: GCPAssessor):
        """Add GCP assessor."""
        self.gcp = assessor

    def analyze(self) -> Dict[str, Any]:
        """Run multi-cloud analysis."""
        findings = []
        if self.aws:
            findings.extend(self.aws.findings)
        if self.azure:
            findings.extend(self.azure.findings)
        if self.gcp:
            findings.extend(self.gcp.findings)

        return {
            'total': len(findings),
            'critical': len([f for f in findings if f.severity == 'critical']),
            'high': len([f for f in findings if f.severity == 'high']),
            'findings': findings
        }

    def generate_report(self, filepath: str):
        """Generate multi-cloud report."""
        logger.info(f"Generating report: {filepath}")
