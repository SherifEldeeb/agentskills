#!/usr/bin/env python3
"""
Pentest Reporting Utility Functions

Utilities for penetration test report generation.

Usage:
    from report_utils import PentestReport, Finding, ReportGenerator
"""

import logging
from datetime import datetime
from typing import Dict, List, Any
from dataclasses import dataclass, field

logger = logging.getLogger(__name__)


@dataclass
class Finding:
    """Security finding."""
    title: str
    severity: str
    cvss: float = 0.0
    cvss_vector: str = ''
    cwe: str = ''
    affected_assets: List[str] = field(default_factory=list)
    description: str = ''
    steps: List[str] = field(default_factory=list)
    evidence: List[Dict[str, str]] = field(default_factory=list)
    impact: str = ''
    remediation: str = ''
    references: List[str] = field(default_factory=list)
    status: str = 'open'

    def set_cvss(self, score: float, vector: str = ''):
        """Set CVSS score."""
        self.cvss = score
        self.cvss_vector = vector

    def set_cwe(self, cwe: str):
        """Set CWE identifier."""
        self.cwe = cwe

    def add_affected_asset(self, asset: str):
        """Add affected asset."""
        self.affected_assets.append(asset)

    def set_description(self, description: str):
        """Set description."""
        self.description = description.strip()

    def add_step(self, step: str):
        """Add reproduction step."""
        self.steps.append(step)

    def add_evidence(self, path: str, description: str):
        """Add evidence."""
        self.evidence.append({'path': path, 'description': description})

    def set_impact(self, impact: str):
        """Set impact statement."""
        self.impact = impact.strip()

    def set_remediation(self, remediation: str):
        """Set remediation guidance."""
        self.remediation = remediation.strip()

    def add_reference(self, reference: str):
        """Add reference."""
        self.references.append(reference)


class PentestReport:
    """Penetration test report."""

    def __init__(self, title: str):
        self.title = title
        self.client = ''
        self.assessment_type = ''
        self.start_date = ''
        self.end_date = ''
        self.scope = []
        self.team = []
        self.executive_summary = ''
        self.methodology = ''
        self.findings: List[Finding] = []
        self.created_at = datetime.now()

    def set_client(self, client: str):
        """Set client name."""
        self.client = client

    def set_assessment_type(self, assessment_type: str):
        """Set assessment type."""
        self.assessment_type = assessment_type

    def set_dates(self, start: str, end: str):
        """Set assessment dates."""
        self.start_date = start
        self.end_date = end

    def set_scope(self, scope: List[str]):
        """Set assessment scope."""
        self.scope = scope

    def add_team_member(self, name: str, role: str):
        """Add team member."""
        self.team.append({'name': name, 'role': role})

    def set_executive_summary(self, summary: str):
        """Set executive summary."""
        self.executive_summary = summary.strip()

    def set_methodology(self, methodology: str):
        """Set methodology section."""
        self.methodology = methodology.strip()

    def add_finding(self, finding: Finding):
        """Add security finding."""
        self.findings.append(finding)

    def get_statistics(self) -> Dict[str, int]:
        """Get finding statistics."""
        stats = {
            'total': len(self.findings),
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0,
            'info': 0
        }
        for f in self.findings:
            severity = f.severity.lower()
            if severity in stats:
                stats[severity] += 1
        return stats

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary."""
        return {
            'title': self.title,
            'client': self.client,
            'assessment_type': self.assessment_type,
            'dates': {'start': self.start_date, 'end': self.end_date},
            'scope': self.scope,
            'team': self.team,
            'executive_summary': self.executive_summary,
            'methodology': self.methodology,
            'statistics': self.get_statistics(),
            'findings': [f.__dict__ for f in self.findings]
        }


class RiskAssessment:
    """Risk assessment and scoring."""

    SEVERITY_WEIGHTS = {
        'critical': 10,
        'high': 7,
        'medium': 4,
        'low': 1,
        'info': 0
    }

    def __init__(self):
        self.findings_count = {
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0,
            'info': 0
        }

    def add_finding(self, severity: str, count: int = 1):
        """Add finding count."""
        severity = severity.lower()
        if severity in self.findings_count:
            self.findings_count[severity] += count

    def get_summary(self) -> Dict[str, Any]:
        """Get risk summary."""
        total_score = sum(
            self.findings_count[s] * self.SEVERITY_WEIGHTS[s]
            for s in self.findings_count
        )

        if total_score >= 50:
            overall = 'Critical'
        elif total_score >= 30:
            overall = 'High'
        elif total_score >= 15:
            overall = 'Medium'
        else:
            overall = 'Low'

        return {
            'overall_risk': overall,
            'risk_score': total_score,
            **self.findings_count
        }

    def get_priority_list(self) -> List[Dict[str, Any]]:
        """Get prioritized remediation list."""
        return []

    def generate_risk_matrix(self) -> Dict[str, Any]:
        """Generate risk matrix."""
        return {}

    def compare_to_previous(self, previous_path: str) -> Dict[str, Any]:
        """Compare to previous assessment."""
        return {}


class ReportGenerator:
    """Generate reports in various formats."""

    def __init__(self, report: PentestReport):
        self.report = report
        self.template = 'default'
        self.logo = None
        self.colors = {}

    def set_template(self, template: str):
        """Set report template."""
        self.template = template

    def set_logo(self, logo_path: str):
        """Set logo for report."""
        self.logo = logo_path

    def set_colors(self, primary: str = None, accent: str = None):
        """Set color scheme."""
        if primary:
            self.colors['primary'] = primary
        if accent:
            self.colors['accent'] = accent

    def generate_pdf(self, filepath: str):
        """Generate PDF report."""
        logger.info(f"Generating PDF: {filepath}")

    def generate_docx(self, filepath: str):
        """Generate Word document."""
        logger.info(f"Generating DOCX: {filepath}")

    def generate_html(self, filepath: str):
        """Generate HTML report."""
        html = self._generate_html_content()
        with open(filepath, 'w') as f:
            f.write(html)
        logger.info(f"Generated HTML: {filepath}")

    def generate_markdown(self, filepath: str):
        """Generate Markdown report."""
        md = self._generate_markdown_content()
        with open(filepath, 'w') as f:
            f.write(md)
        logger.info(f"Generated Markdown: {filepath}")

    def generate_executive_brief(self, filepath: str):
        """Generate executive brief."""
        logger.info(f"Generating executive brief: {filepath}")

    def generate_technical_appendix(self, filepath: str):
        """Generate technical appendix."""
        logger.info(f"Generating appendix: {filepath}")

    def generate_remediation_tracker(self, filepath: str):
        """Generate remediation tracker."""
        logger.info(f"Generating tracker: {filepath}")

    def _generate_html_content(self) -> str:
        """Generate HTML content."""
        stats = self.report.get_statistics()
        return f"""<!DOCTYPE html>
<html>
<head>
    <title>{self.report.title}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; }}
        .header {{ border-bottom: 2px solid #333; }}
        .finding {{ margin: 20px 0; padding: 15px; border-left: 4px solid #ccc; }}
        .critical {{ border-color: #c00; }}
        .high {{ border-color: #f90; }}
        .medium {{ border-color: #fc0; }}
        .low {{ border-color: #0c0; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>{self.report.title}</h1>
        <p>Client: {self.report.client}</p>
        <p>Assessment: {self.report.assessment_type}</p>
        <p>Dates: {self.report.start_date} - {self.report.end_date}</p>
    </div>

    <h2>Executive Summary</h2>
    <p>{self.report.executive_summary}</p>

    <h2>Findings Summary</h2>
    <ul>
        <li>Critical: {stats['critical']}</li>
        <li>High: {stats['high']}</li>
        <li>Medium: {stats['medium']}</li>
        <li>Low: {stats['low']}</li>
    </ul>

    <h2>Detailed Findings</h2>
    {''.join(self._finding_to_html(f) for f in self.report.findings)}
</body>
</html>"""

    def _finding_to_html(self, finding: Finding) -> str:
        """Convert finding to HTML."""
        return f"""
    <div class="finding {finding.severity.lower()}">
        <h3>{finding.title}</h3>
        <p><strong>Severity:</strong> {finding.severity} (CVSS: {finding.cvss})</p>
        <p><strong>Description:</strong> {finding.description}</p>
        <p><strong>Impact:</strong> {finding.impact}</p>
        <p><strong>Remediation:</strong> {finding.remediation}</p>
    </div>"""

    def _generate_markdown_content(self) -> str:
        """Generate Markdown content."""
        stats = self.report.get_statistics()
        md = f"""# {self.report.title}

**Client:** {self.report.client}
**Assessment Type:** {self.report.assessment_type}
**Dates:** {self.report.start_date} - {self.report.end_date}

---

## Executive Summary

{self.report.executive_summary}

## Findings Summary

| Severity | Count |
|----------|-------|
| Critical | {stats['critical']} |
| High | {stats['high']} |
| Medium | {stats['medium']} |
| Low | {stats['low']} |

## Detailed Findings

"""
        for i, f in enumerate(self.report.findings, 1):
            md += f"""### {i}. {f.title}

**Severity:** {f.severity} (CVSS: {f.cvss})

**Description:** {f.description}

**Impact:** {f.impact}

**Remediation:** {f.remediation}

---

"""
        return md


class EvidenceManager:
    """Manage assessment evidence."""

    def __init__(self, assessment_id: str):
        self.assessment_id = assessment_id
        self.screenshots = []
        self.requests = []
        self.outputs = []

    def add_screenshot(self, path: str, finding: str, description: str):
        """Add screenshot."""
        self.screenshots.append({
            'path': path,
            'finding': finding,
            'description': description
        })

    def add_request_response(self, path: str, finding: str, description: str):
        """Add request/response."""
        self.requests.append({
            'path': path,
            'finding': finding,
            'description': description
        })

    def add_command_output(self, command: str, output: str, finding: str):
        """Add command output."""
        self.outputs.append({
            'command': command,
            'output': output,
            'finding': finding
        })

    def organize_by_finding(self):
        """Organize evidence by finding."""
        logger.info("Organizing evidence by finding")

    def create_package(self, filepath: str):
        """Create evidence package."""
        logger.info(f"Creating evidence package: {filepath}")

    def generate_index(self, filepath: str):
        """Generate evidence index."""
        index = f"# Evidence Index - {self.assessment_id}\n\n"
        index += f"## Screenshots ({len(self.screenshots)})\n\n"
        for s in self.screenshots:
            index += f"- {s['path']}: {s['description']}\n"
        with open(filepath, 'w') as f:
            f.write(index)
